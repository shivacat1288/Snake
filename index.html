<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="x-ua-compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snake</title>
    <link rel="manifest" href="manifest.json">

    <style>
        body {
            margin: 0;
            min-height: 100vh;
            background: radial-gradient(circle at top, #1b0033, #000);
            color: #fff;
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .game-wrapper {
            display: flex;
            gap: 30px;
            margin-top: 30px;
        }

        /* üêç CANVAS */
        canvas {
            background: #000;
            border: 3px solid #00ffff;
            box-shadow:
                0 0 10px #00ffff,
                0 0 20px #00ffff,
                inset 0 0 10px #00ffff;

            width: 100%;
            max-width: 480px;
            aspect-ratio: 1 / 1;
        }

        /* üèÜ SCOREBOARD */
        .score-board {
            min-width: 200px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #ff00ff;
            box-shadow:
                0 0 10px #ff00ff,
                0 0 20px #ff00ff;
        }

        .score-board p {
            font-size: 18px;
            text-align: center;
            margin-bottom: 10px;
            color: #00ffff;
            text-shadow: 0 0 5px #00ffff;
        }

        .score-board h3 {
            text-align: center;
            margin: 10px 0;
            color: #ff00ff;
            text-shadow: 0 0 8px #ff00ff;
            letter-spacing: 2px;
        }

        .score-board ol {
            padding-left: 20px;
            margin: 0;
        }

        .score-board li {
            margin-bottom: 6px;
            color: #fff;
            text-shadow: 0 0 5px #00ffff;
        }

        /* üèÖ Platz 1 extra Glow */
        .score-board li:first-child {
            color: #ffff00;
            text-shadow:
                0 0 5px #ffff00,
                0 0 10px #ffff00;
            font-weight: bold;
        }

        /* ‚úçÔ∏è NAME INPUT */
        #name-input {
            margin-top: 20px;
            padding: 15px;
            border: 2px solid #00ffff;
            box-shadow:
                0 0 10px #00ffff,
                0 0 20px #00ffff;
            background: rgba(0, 0, 0, 0.9);
            text-align: center;
        }

        #name-input p {
            margin-bottom: 10px;
            color: #ff00ff;
            text-shadow: 0 0 6px #ff00ff;
        }

        #name-input input {
            background: #000;
            border: 2px solid #00ffff;
            color: #00ffff;
            padding: 6px;
            font-family: 'Courier New', monospace;
            text-align: center;
            outline: none;
            box-shadow: 0 0 8px #00ffff;
        }

        #name-input button {
            margin-left: 8px;
            padding: 6px 12px;
            background: black;
            border: 2px solid #ff00ff;
            color: #ff00ff;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            box-shadow: 0 0 10px #ff00ff;
            transition: all 0.2s ease;
        }

        #name-input button:hover {
            background: #ff00ff;
            color: black;
            box-shadow:
                0 0 15px #ff00ff,
                0 0 25px #ff00ff;
        }

        canvas {
            touch-action: none;
        }

        @media (max-width: 768px) {

            .game-wrapper {
                flex-direction: column;
                align-items: center;
                gap: 20px;
            }

            .score-board {
                width: 90%;
                max-width: 400px;
            }

            body {
                padding-bottom: 20px;
            }
        }
    </style>


</head>

<body>


    <div class="game-wrapper">
        <canvas id="canvas" width="480" height="480"></canvas>

        <div class="score-board">
            <p>Score: <span id="score">0</span></p>
            <p>Level: <span id="speed-level">1</span></p>
            <br>
            <h3>Top 5</h3>
            <ol id="highscore-list"></ol>
        </div>
    </div>

    <div id="name-input" style="display:none">
        <p>Neuer Highscore!</p>
        <input type="text" id="player-name" maxlength="10" placeholder="Name">
        <button onclick="saveHighscore()">Speichern</button>
    </div>

    <script>
        let canvas = document.getElementById('canvas');
        let ctx = canvas.getContext('2d');
        let rows = 30; // zeilen im Canvas
        let cols = 30; // spalten im Canvas
        let snake = [{
            x: 26, y: 3 // Die Schlange startet immer an diesen Koordinaten
        },
        ];
        let food;
        let cellWidth = canvas.width / cols;
        let cellHeight = canvas.height / rows;
        let direction = "LEFT";
        let foodCollected = false;
        let score = 0;
        let gameOver = false;
        let gameInterval;
        let highscores = JSON.parse(localStorage.getItem('highscores')) || [];
        let eatsound = new Audio('eat.mp3');
        eatsound.volume = 0.1;
        let bgMusic = new Audio('Tetris.mp3');
        bgMusic.loop = true;
        bgMusic.volume = 0.4;
        let musicOn = true;
        let musicUnlocked = false;
        let nextDirection = "LEFT";
        let baseSpeed = 200;      // Startgeschwindigkeit (ms)
        let speedStep = 10;      // wie viel schneller (ms)
        let minSpeed = 60;       // Maximum-Speed (Untergrenze)
        let speedLevel = 0; // wie oft wir schneller geworden sind
        let levelUpSound = new Audio('levelup.mp3');
        levelUpSound.volume = 0.4;
        let touchStartX = 0;
        let touchStartY = 0;
        let touchEndX = 0;
        let touchEndY = 0;
        let gameStarted = false;

        let silentAudio = new Audio();
        silentAudio.src = "data:audio/mp3;base64,//uQxAAAAAAAAAAAAAAAAAAAAAA==";
        silentAudio.loop = true;
        [eatsound, bgMusic, levelUpSound].forEach(a => {
            a.preload = 'auto';
            a.playsInline = true;     // üîë iOS FIX
            a.muted = false;
        });

        placefood(); // f√ºhrt die aktion food hinzuf√ºgen aus


        document.addEventListener('keydown', keyDown);
        canvas.addEventListener('touchstart', e => {
            const touch = e.touches[0];
            touchStartX = touch.clientX;
            touchStartY = touch.clientY;
        }, { passive: true });


        canvas.addEventListener('click', unlockAudio);
        canvas.addEventListener('touchstart', unlockAudio);

        canvas.addEventListener('touchend', e => {
            const touch = e.changedTouches[0];
            touchEndX = touch.clientX;
            touchEndY = touch.clientY;

            handleSwipe();
        });

        draw(); // ist die zeichnen funktion

        renderHighscores();

        document.getElementById('speed-level').textContent = speedLevel + 1;

        function draw() {

            ctx.fillStyle = 'black'; // Cnnvas(hintergrund)
            ctx.fillRect(0, 0, canvas.width, canvas.height);



            ctx.fillStyle = 'white'; // welche farbe hat die schlange

            snake.forEach(part => add(part.x, part.y))


            ctx.fillStyle = 'yellow'
            add(food.x, food.y) // Food


            if (gameOver) {
                ctx.fillStyle = 'red';
                ctx.font = '40px Arial';
                ctx.fillText('GAME OVER', 120, 220);


                ctx.fillStyle = 'white';
                ctx.font = '20px Arial';
                ctx.fillText(`Gesamtpunkte: ${score}`, 170, 260);
                ctx.font = '16px Arial';
                ctx.fillText('Leertaste zum Neustart', 165, 350);

            }

            requestAnimationFrame(draw);

        }

        function unlockAudio() {
            if (gameStarted) return;

            gameStarted = true;
            musicUnlocked = true;

            // üîä Audio-Engine freischalten (ECHTER Sound!)
            eatsound.currentTime = 0;
            eatsound.volume = 0.05;

            eatsound.play().then(() => {
                eatsound.pause();
                eatsound.currentTime = 0;
                eatsound.volume = 0.1;
            }).catch(() => { });

            // üéµ Hintergrundmusik
            if (musicOn) {
                bgMusic.currentTime = 0;
                bgMusic.play().catch(() => { });
            }

            // ‚ñ∂Ô∏è GAME STARTET ERST JETZT
            gameInterval = setInterval(gameloop, baseSpeed);
        }

        function testGameOver() {


            let head = snake[0];
            let body = snake.slice(1);

            let hitSelf = body.some(part => part.x === head.x && part.y === head.y);
            let hitWall =
                head.x < 0 ||
                head.x >= cols ||
                head.y < 0 ||
                head.y >= rows;

            if (hitWall || hitSelf) {
                gameOver = true;
                clearInterval(gameInterval);
                bgMusic.pause();

                // ‚úÖ Highscore NUR hier setzen
                const qualifies =
                    highscores.length < 5 ||
                    score > highscores[highscores.length - 1].score;

                if (qualifies) {
                    document.getElementById('name-input').style.display = 'block';
                    document.getElementById('player-name').focus();
                }
            }
        }

        function saveHighscore() {
            const input = document.getElementById('player-name');
            let name = input.value.trim();

            if (name === '') name = '???';

            highscores.push({ name, score });

            highscores.sort((a, b) => b.score - a.score);
            highscores = highscores.slice(0, 5);

            localStorage.setItem('highscores', JSON.stringify(highscores));
            renderHighscores();

            // UI zur√ºcksetzen
            input.value = '';
            document.getElementById('name-input').style.display = 'none';
            restartGame();
        }

        function placefood() {
            let valid = false;

            while (!valid) {
                let randomX = Math.floor(Math.random() * cols);
                let randomY = Math.floor(Math.random() * rows);

                valid = !snake.some(part => part.x === randomX && part.y === randomY);

                if (valid) {
                    food = { x: randomX, y: randomY };
                }
            }
        }


        function add(x, y,) {
            ctx.fillRect(x * cellWidth, y * cellHeight, cellWidth - 1, cellHeight - 1);
        }

        function shiftSnake() { // Schlange soll wachsen
            for (let i = snake.length - 1; i > 0; i--) {
                const part = snake[i];
                const lastPart = snake[i - 1];
                part.x = lastPart.x;
                part.y = lastPart.y;
            }
        }

        function gameloop() {
            if (gameOver) return;
            direction = nextDirection;

            if (foodCollected) {
                snake = [{
                    x: snake[0].x,
                    y: snake[0].y
                }, ...snake];

                foodCollected = false;
            }

            shiftSnake();

            if (direction == 'LEFT') {
                snake[0].x--;
            }
            if (direction == 'UP') {
                snake[0].y--;
            }
            if (direction == 'RIGHT') {
                snake[0].x++;
            }
            if (direction == 'DOWN') {
                snake[0].y++;
            }

            // Futer einsammeln und Punkte hoch setzen
            if (snake[0].x == food.x &&
                snake[0].y == food.y) {
                score++;
                document.getElementById('score').textContent = score;
                foodCollected = true;
                placefood();

                eatsound.currentTime = 0; // wichtig bei schnellem Essen
                eatsound.play();
            }




            // ‚è© Alle 10 Segmente genau EINMAL schneller
            let newLevel = Math.floor(snake.length / 10);

            if (newLevel > speedLevel) {
                speedLevel = newLevel;

                let newSpeed = Math.max(
                    minSpeed,
                    baseSpeed - speedLevel * speedStep
                );

                clearInterval(gameInterval);
                gameInterval = setInterval(gameloop, newSpeed);

                // üîä LEVEL-UP SOUND
                levelUpSound.currentTime = 0;
                levelUpSound.play();

                document.getElementById('speed-level').textContent = speedLevel + 1;

            }






            testGameOver();

        }


        function keyDown(e) {

            // üîì Musik einmalig freischalten (Browser-Regel)
            if (!musicUnlocked) {
                bgMusic.play().then(() => {
                    bgMusic.pause();
                    bgMusic.currentTime = 0;
                    musicUnlocked = true;

                    // Musik direkt starten
                    if (musicOn) {
                        bgMusic.play();
                    }
                }).catch(() => { });
            }

            if (gameOver && e.keyCode === 32) {
                if (document.getElementById('name-input').style.display === 'none') {
                    restartGame();
                }
                return;
            }

            if (gameOver) return;

            // üéÆ Steuerung
            if (e.keyCode == 37 && direction !== 'RIGHT') nextDirection = 'LEFT';
            if (e.keyCode == 38 && direction !== 'DOWN') nextDirection = 'UP';
            if (e.keyCode == 39 && direction !== 'LEFT') nextDirection = 'RIGHT';
            if (e.keyCode == 40 && direction !== 'UP') nextDirection = 'DOWN';

            // üéµ Musik Pause / Resume mit M
            if (e.key.toLowerCase() === 'm') {
                musicOn = !musicOn;

                if (musicOn) {
                    bgMusic.play();
                } else {
                    bgMusic.pause();
                }
            }
        }

        function handleSwipe() {
            let dx = touchEndX - touchStartX;
            let dy = touchEndY - touchStartY;

            // Mindestbewegung (Deadzone)
            if (Math.abs(dx) < 30 && Math.abs(dy) < 30) return;

            if (Math.abs(dx) > Math.abs(dy)) {
                // Horizontal
                if (dx > 0 && direction !== 'LEFT') {
                    nextDirection = 'RIGHT';
                } else if (dx < 0 && direction !== 'RIGHT') {
                    nextDirection = 'LEFT';
                }
            } else {
                // Vertikal
                if (dy > 0 && direction !== 'UP') {
                    nextDirection = 'DOWN';
                } else if (dy < 0 && direction !== 'DOWN') {
                    nextDirection = 'UP';
                }
            }
        }

        function restartGame() {
            clearInterval(gameInterval);

            document.getElementById('name-input').style.display = 'none';

            snake = [{ x: 26, y: 3 }];
            direction = "LEFT";
            nextDirection = "LEFT";
            score = 0;
            speedLevel = 0; // ‚úÖ wichtig
            document.getElementById('speed-level').textContent = 1;
            document.getElementById('score').textContent = score;
            gameOver = false;
            foodCollected = false;

            placefood();

            gameInterval = setInterval(gameloop, baseSpeed);

            if (musicOn && musicUnlocked) {
                bgMusic.currentTime = 0;
                bgMusic.play();
            }
        }
        function renderHighscores() {
            const list = document.getElementById('highscore-list');
            list.innerHTML = '';

            highscores.forEach(entry => {
                const li = document.createElement('li');
                li.textContent = `${entry.name} ‚Äì ${entry.score}`;
                list.appendChild(li);
            });
        }

        document.getElementById('player-name').addEventListener('keydown', e => {
            if (e.key === 'Enter') {
                saveHighscore();
            }
        });

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
        

    </script>

</body>




</html>
